<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.lab.dao.CounselingDAO">
	<select id="selectTotalRecord" parameterType="PagingVO" resultType="int">
		SELECT COUNT(*)
		FROM COUNSELING
	</select>
	<resultMap type="CounselingVO" id="CounMap">
		<id property="counNo" column="COUN_NO"/>
	</resultMap>
	<select id="selectCounList" parameterType="PagingVO" resultMap="CounMap">
		WITH COUNBOARD AS(
		    SELECT
			    C.COUN_NO, C.MEM_ID, M.MEM_NAME, C.COUN_TITLE, C.COUN_CONTENT
			    , to_char(C.COUN_DATE, 'YYYY-MM-DD') COUN_DATE
			    , C.COUN_STATE, C.REF_COUN
			    , (SELECT COUNT(COUN_NO) FROM COUNSELING WHERE REF_COUN=C.COUN_NO) ISREFED
		    FROM COUNSELING C LEFT OUTER JOIN MEMBER M ON(C.MEM_ID= M.MEM_ID)
		    WHERE REF_COUN IS NULL AND C.COUN_STATE='B1'
		)
		SELECT A.*
		FROM(
		    SELECT ROWNUM RNUM, COUNBOARD.*
		    FROM COUNBOARD
		) A
		WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	</select>
	
	<resultMap type="CounselingVO" id="counMap" autoMapping="true">
		<id property="counNo" column="COUN_NO"/>
		<association property="reCoun" javaType="CounselingVO" autoMapping="true" >
			<id property="counNo" column="COUN_NO2"/>
			<result property="counNo" column="COUN_NO2"/>
			<result property="memId" column="MEM_ID2"/>
			<result property="counTitle" column="COUN_TITLE2"/>
			<result property="counContent" column="COUN_CONTENT2"/>
			<result property="counDate" column="COUN_DATE2"/>
			<result property="counState" column="COUN_STATE2"/>
		</association>
	</resultMap>
	<select id="selectCoun" parameterType="string" resultMap="counMap">
		SELECT 
		    A.COUN_NO
		    , A.MEM_ID
		    , M.MEM_NAME
		    , A.COUN_TITLE
		    , A.COUN_CONTENT
		    , to_char(A.COUN_DATE,'YYYY-MM-DD') COUN_DATE
		    , A.COUN_STATE
		    , B.COUN_NO COUN_NO2
		    , B.MEM_ID MEM_ID2
		    , B.COUN_TITLE COUN_TITLE2
		    , B.COUN_CONTENT COUN_CONTENT2
		    , to_char(B.COUN_DATE,'YYYY-MM-DD') COUN_DATE2
		    , B.COUN_STATE COUN_STATE2
		FROM COUNSELING A INNER JOIN COUNSELING B ON(A.COUN_NO = B.REF_COUN)
						LEFT OUTER JOIN MEMBER M ON(A.MEM_ID= M.MEM_ID)
		WHERE A.COUN_NO= #{counNo,jdbcType=VARCHAR}
	</select>
	<insert id="insertCoun" parameterType="CounselingVO">
		INSERT INTO COUNSELING(
		    COUN_NO
		    , MEM_ID
		    , COUN_TITLE
		    , COUN_CONTENT
		    , COUN_DATE
		    , COUN_STATE
		    , REF_COUN
		)
		VALUES(
		    (SELECT 'CS' || LPAD(COUNS_SEQ.NEXTVAL,6,0) FROM DUAL)
		    , #{memId,jdbcType=VARCHAR}
		    , #{counTitle,jdbcType=VARCHAR}
		    , #{counContent,jdbcType=CLOB}
		    , SYSDATE
		    , 'B1'
		    , #{refCoun,jdbcType=VARCHAR}
		)
	</insert>
</mapper>